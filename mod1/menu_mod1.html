<!DOCTYPE html>
<html lang="pt_BR">

<head>
    <title>Índice do Módulo 1...</title>
    

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="../css/main.css"> 
    <style type="text/css">
        #w1 { margin-top: 28px; } #w2 { margin-top: 40px; } #w3 { margin: 0 16px; } #w4 { margin: 0 16px; } #w5 { margin-top: 80px; } #w6 { margin-top: 62px; } #w7 { position: absolute; bottom: -60px; right: 0; } #w8 { margin-top: 94px; }
	
		.bt-reset{
			background-color: crimson;
			color: white;
			margin: 2em;
			position: right;
		}
	</style>

    <script>
        var ie = (!!window.ActiveXObject && +(/msie\s(\d+)/i.exec(navigator.userAgent)[1])) || NaN;
        if (ie === 6)
            document.documentElement.className += ' ie6';
        else if (ie === 7)
            document.documentElement.className += ' ie7';
        else if (ie === 8)
            document.documentElement.className += ' ie8';
    </script>
</head>

<body>
	<h1>Índice do Módulo 1</h1>
	<div id="nav-unidades">	
		
		<div class="link-unidade" id="div-uni1">
			<a href="uni1/index.html">Unidade 1</a>
			<span class="progress-bar" id="barra-progresso-uni1"></span>
			<span class="texto-progresso" id="texto-progresso-uni1">xxxxx</span>	
			<span class="bt-reset" id="bt-reset-uni1">Reiniciar Progresso</span>	
		</div>
				
		<div class="link-unidade" id="div-uni2">
			<a href="uni2/index.html">Unidade 2</a>			
			<span class="progress-bar" id="barra-progresso-uni2"></span>
			<span class="texto-progresso" id="texto-progresso-uni2"> </span>						
			<span class="bt-reset" id="bt-reset-uni2">Reiniciar Progresso</span>
		</div>

		
		<div class="link-unidade" id="div-uni3">
			<a href="uni3/index.html">Unidade 3</a>			
			<span class="progress-bar" id="barra-progresso-uni3"></span>
			<span class="texto-progresso" id="texto-progresso-uni3"> </span>
			<span class="bt-reset" id="bt-reset-uni3">Reiniciar Progresso</span>
		</div>
		
		<div class="link-unidade" id="div-uni4">
			<a href="uni4/index.html">Unidade 4</a>			
			<span class="progress-bar" id="barra-progresso-uni4"></span>
			<span class="texto-progresso" id="texto-progresso-uni4"> </span>			
			<span class="bt-reset" id="bt-reset-uni4">Reiniciar Progresso</span>
		</div>
	</div>
	
	
	
</body>
	
	<script src="https://cdn.jsdelivr.net/npm/@labtime/avamec-api-bridge-cliente@latest/dist/bridge-rest-api.bundle.js"></script>

<script>	
	console.clear(screen);
	var API = new BridgeRestApi();
	//a variável da quantidade de Unidades que há no Curso
	var quantUnidades=4;
	//contagem das unidades para referência a cada laço for. começa em 1
	var uniAtual = 1;
	//vetor que vai ter as chaves dos dados genéricos
	var porcentagemUnidades={};
	
	const 
	//botões de reset para teste
	reset1 = document.querySelector('#bt-reset-uni1'),reset2 = document.querySelector('#bt-reset-uni2'),reset3 = document.querySelector('#bt-reset-uni3'),reset4 = document.querySelector('#bt-reset-uni4');
	
	console.log("Começando o teste");
	window.addEventListener('load', function(){ 
		//o for vai criar o array com as chaves das unidades e chamar a função obterDadosGenericos com essas chaves
		for(var cont=1; cont<=quantUnidades ;cont++){
			console.log("\n\nUnidade Atual: "+uniAtual);
			porcentagemUnidades[cont] = 'porcentagemUni'+(cont);
			console.log(porcentagemUnidades);
			//primeiro verifica os dados salvos
			API.obterDadosGenericos(porcentagemUnidades[cont]);			
			console.log("cont:::"+cont);			
		}
		
		//Adicionando listener para o evento dos dados genériocs		
		window.addEventListener("evObtemDadosGenericos",function(evento){			
			console.log("\n\nObtendo os dados genéricos: "+porcentagemUnidades[uniAtual]);            			
			//console.log(evento.detail);				
			console.log("Status do evento: "+evento.detail['status']);								
			
			//verifica qual o código retornado, pra saber se a unidade já foi começada				
			if(evento.detail["status"]=="200"){				
				//se a unidade já foi iniciada, então vai ter porcentagem.
				var porcentagem = evento.detail["data"][0]["valor"];        										
				console.log(porcentagemUnidades[uniAtual]+" tem "+(porcentagem)+"% concluída"); 									
				//aqui preenche a barra de progresso e o texto
				var barraprogresso = document.querySelector("#barra-progresso-uni"+uniAtual);
				barraprogresso.style.setProperty("--progress",porcentagem);
				var textoprogresso = document.querySelector("#texto-progresso-uni"+uniAtual);
				textoprogresso.textContent = porcentagem+'% concluído';
			
			//se a unidade não foi iniciada, registra os dados Genéricos da unidade com 0%
			}else{
				API.registrarDadosGenericos(porcentagemUnidades[uniAtual],0);
				console.log("Porcentagem da Unidade "+(uniAtual)+" Iniciada");	   
			}			
			//depois de tratar os dados, pula para a próxima unidade.			
			uniAtual++;
		});
	
	});
	

	//Eventos para reiniciar os progressos das unidades quando os botões sao clicados
	reset1.addEventListener('click',function(){
		API.registrarDadosGenericos("porcentagemUni1",0);            
            window.addEventListener('evObtemRegistraDadosGenericos', resultadoRegistrarDadosGenericos, false);
            function resultadoRegistrarDadosGenericos (evento){
            	console.log("Reiniciando progresso da unidade 1");
                console.log(evento.detail);
            };
	});
	reset2.addEventListener('click',function(){
		API.registrarDadosGenericos("porcentagemUni2",0);            
            window.addEventListener('evObtemRegistraDadosGenericos', resultadoRegistrarDadosGenericos, false);
            function resultadoRegistrarDadosGenericos (evento){
            	console.log("Reiniciando progresso da unidade 2");
                console.log(evento.detail);
            };
	});
	reset3.addEventListener('click',function(){
		API.registrarDadosGenericos("porcentagemUni3",0);            
            window.addEventListener('evObtemRegistraDadosGenericos', resultadoRegistrarDadosGenericos, false);
            function resultadoRegistrarDadosGenericos (evento){
            	console.log("Reiniciando progresso da unidade 3");
                console.log(evento.detail);
            };
	});
	reset4.addEventListener('click',function(){
		API.registrarDadosGenericos("porcentagemUni4",0);            
            window.addEventListener('evObtemRegistraDadosGenericos', resultadoRegistrarDadosGenericos, false);
            function resultadoRegistrarDadosGenericos (evento){
            	console.log("Reiniciando progresso da unidade 4");
                console.log(evento.detail);
            };
	});
</script>

</html>